<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Quiz - EduTutor AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">
                <i class="fas fa-brain me-2"></i>EduTutor AI
            </a>
            
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('dashboard') }}">
                    <i class="fas fa-home me-1"></i>Dashboard
                </a>
                <a class="nav-link" href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-4">
        <!-- Quiz Setup -->
        <div id="quiz-setup" class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow-lg">
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                                <i class="fas fa-brain text-white fa-2x"></i>
                            </div>
                            <h2 class="fw-bold">Create Your AI-Powered Quiz</h2>
                            <p class="text-muted">Generate personalized questions using IBM Granite AI</p>
                        </div>

                        <form id="quiz-form" class="needs-validation" novalidate>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="topic" class="form-label fw-semibold">
                                        <i class="fas fa-book me-2"></i>Select Topic
                                    </label>
                                    <select class="form-select form-select-lg" id="topic" required>
                                        <option value="">Choose a topic...</option>
                                        <option value="Mathematics">Mathematics</option>
                                        <option value="Physics">Physics</option>
                                        <option value="Chemistry">Chemistry</option>
                                        <option value="Biology">Biology</option>
                                        <option value="Computer Science">Computer Science</option>
                                        <option value="History">History</option>
                                        <option value="Geography">Geography</option>
                                        <option value="Literature">Literature</option>
                                        <option value="Economics">Economics</option>
                                        <option value="Psychology">Psychology</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Please select a topic.
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="difficulty" class="form-label fw-semibold">
                                        <i class="fas fa-chart-line me-2"></i>Difficulty Level
                                    </label>
                                    <select class="form-select form-select-lg" id="difficulty" required>
                                        <option value="easy">ðŸŸ¢ Easy - Basic concepts</option>
                                        <option value="medium" selected>ðŸŸ¡ Medium - Intermediate level</option>
                                        <option value="hard">ðŸ”´ Hard - Advanced challenges</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="num_questions" class="form-label fw-semibold">
                                    <i class="fas fa-list-ol me-2"></i>Number of Questions: <span id="question-count">5</span>
                                </label>
                                <input type="range" class="form-range" id="num_questions" min="3" max="15" value="5" oninput="updateQuestionCount(this.value)">
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted">3 questions</small>
                                    <small class="text-muted">15 questions</small>
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>Estimated time: <span id="estimated-time">7.5</span> minutes
                                </small>
                            </div>

                            <button type="submit" class="btn btn-primary btn-lg w-100 mb-3">
                                <i class="fas fa-rocket me-2"></i>Generate Quiz with IBM Granite AI
                            </button>
                        </form>

                        <!-- AI Features Preview -->
                        <div class="row mt-4 text-center">
                            <div class="col-4">
                                <i class="fas fa-brain text-primary fa-2x mb-2"></i>
                                <h6>AI-Powered</h6>
                                <small class="text-muted">Questions generated by IBM Granite AI</small>
                            </div>
                            <div class="col-4">
                                <i class="fas fa-chart-line text-success fa-2x mb-2"></i>
                                <h6>Adaptive</h6>
                                <small class="text-muted">Difficulty adjusts to your level</small>
                            </div>
                            <div class="col-4">
                                <i class="fas fa-clock text-warning fa-2x mb-2"></i>
                                <h6>Instant Feedback</h6>
                                <small class="text-muted">Get results immediately</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quiz Interface -->
        <div id="quiz-interface" class="d-none">
            <!-- Quiz Header -->
            <div class="card shadow mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 id="quiz-title" class="mb-1"></h4>
                            <p id="quiz-info" class="text-muted mb-0"></p>
                        </div>
                        <div class="text-end">
                            <div class="h5 mb-0" id="timer">30:00</div>
                            <small class="text-muted">Time remaining</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="card shadow mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Progress</span>
                        <span id="progress-text">0/5 answered</span>
                    </div>
                    <div class="progress">
                        <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Questions Container -->
            <div id="questions-container"></div>

            <!-- Navigation -->
            <div class="card shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <button id="prev-btn" class="btn btn-outline-secondary" disabled>
                            <i class="fas fa-arrow-left me-2"></i>Previous
                        </button>
                        
                        <div id="question-indicators" class="d-flex gap-2"></div>
                        
                        <div>
                            <button id="next-btn" class="btn btn-primary">
                                Next<i class="fas fa-arrow-right ms-2"></i>
                            </button>
                            
                            <button id="submit-btn" class="btn btn-success d-none">
                                <i class="fas fa-check me-2"></i>Submit Quiz
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quiz Results -->
        <div id="quiz-results" class="d-none">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card shadow-lg">
                        <div class="card-body text-center p-5">
                            <div id="score-circle" class="mb-4">
                                <div class="display-1 font-weight-bold" id="final-score">85%</div>
                            </div>
                            
                            <h2 id="result-title">Great Job!</h2>
                            <p id="result-message" class="text-muted mb-4"></p>
                            
                            <div id="feedback-section" class="alert alert-info mb-4"></div>
                            
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <button class="btn btn-primary w-100" onclick="resetQuiz()">
                                        <i class="fas fa-redo me-2"></i>Take Another Quiz
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <a href="{{ url_for('history') }}" class="btn btn-success w-100">
                                        <i class="fas fa-chart-line me-2"></i>View History
                                    </a>
                                </div>
                                <div class="col-md-4">
                                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary w-100">
                                        <i class="fas fa-home me-2"></i>Dashboard
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5>Generating your personalized quiz...</h5>
                    <p class="text-muted">IBM Granite AI is creating questions tailored to your learning level</p>
                    <div class="progress mt-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentQuiz = null;
        let currentQuestion = 0;
        let answers = {};
        let timer = null;
        let timeLeft = 1800; // 30 minutes
        let startTime = null;

        function updateQuestionCount(value) {
            document.getElementById('question-count').textContent = value;
            document.getElementById('estimated-time').textContent = (value * 1.5).toFixed(1);
        }

        // Form validation
        (function() {
            'use strict';
            window.addEventListener('load', function() {
                var forms = document.getElementsByClassName('needs-validation');
                var validation = Array.prototype.filter.call(forms, function(form) {
                    form.addEventListener('submit', function(event) {
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();

        document.getElementById('quiz-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!this.checkValidity()) {
                return;
            }
            
            const topic = document.getElementById('topic').value;
            const difficulty = document.getElementById('difficulty').value;
            const numQuestions = document.getElementById('num_questions').value;
            
            // Show loading modal
            const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            loadingModal.show();
            
            try {
                const response = await fetch('/api/generate_quiz', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        topic: topic,
                        difficulty: difficulty,
                        num_questions: parseInt(numQuestions)
                    })
                });
                
                if (response.ok) {
                    currentQuiz = await response.json();
                    loadingModal.hide();
                    startQuiz();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to generate quiz');
                }
            } catch (error) {
                loadingModal.hide();
                alert('Error generating quiz: ' + error.message);
            }
        });

        function startQuiz() {
            document.getElementById('quiz-setup').classList.add('d-none');
            document.getElementById('quiz-interface').classList.remove('d-none');
            
            // Set quiz info
            document.getElementById('quiz-title').textContent = currentQuiz.title;
            document.getElementById('quiz-info').textContent = `Topic: ${currentQuiz.topic} â€¢ Difficulty: ${currentQuiz.difficulty} â€¢ Questions: ${currentQuiz.questions.length}`;
            
            // Initialize timer
            timeLeft = (currentQuiz.time_limit || 30) * 60;
            startTime = Date.now();
            startTimer();
            
            // Create question indicators
            createQuestionIndicators();
            
            // Load first question
            loadQuestion(0);
        }

        function startTimer() {
            timer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    submitQuiz();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timerElement = document.getElementById('timer');
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Change color when time is running low
            if (timeLeft < 300) { // Less than 5 minutes
                timerElement.className = 'h5 mb-0 text-danger';
            } else if (timeLeft < 600) { // Less than 10 minutes
                timerElement.className = 'h5 mb-0 text-warning';
            }
        }

        function createQuestionIndicators() {
            const container = document.getElementById('question-indicators');
            container.innerHTML = '';
            
            for (let i = 0; i < currentQuiz.questions.length; i++) {
                const indicator = document.createElement('button');
                indicator.className = 'btn btn-outline-primary btn-sm';
                indicator.textContent = i + 1;
                indicator.onclick = () => loadQuestion(i);
                container.appendChild(indicator);
            }
        }

        function loadQuestion(index) {
            currentQuestion = index;
            const question = currentQuiz.questions[index];
            
            const container = document.getElementById('questions-container');
            container.innerHTML = `
                <div class="card shadow mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-start mb-4">
                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                <i class="fas fa-question text-white"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h5 class="mb-3">Question ${index + 1}: ${question.question}</h5>
                                <div class="options">
                                    ${question.options.map((option, i) => `
                                        <div class="form-check mb-3 p-3 border rounded ${answers[index] === i ? 'bg-primary bg-opacity-10 border-primary' : ''}">
                                            <input class="form-check-input" type="radio" name="question_${index}" id="option_${i}" value="${i}" ${answers[index] === i ? 'checked' : ''}>
                                            <label class="form-check-label w-100" for="option_${i}">
                                                <strong>${String.fromCharCode(65 + i)}.</strong> ${option}
                                            </label>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listeners for answer selection
            const radioButtons = container.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    answers[index] = parseInt(this.value);
                    updateProgress();
                    updateQuestionIndicators();
                    
                    // Update visual feedback
                    const formChecks = container.querySelectorAll('.form-check');
                    formChecks.forEach((check, i) => {
                        if (i === parseInt(this.value)) {
                            check.classList.add('bg-primary', 'bg-opacity-10', 'border-primary');
                        } else {
                            check.classList.remove('bg-primary', 'bg-opacity-10', 'border-primary');
                        }
                    });
                });
            });
            
            // Update navigation buttons
            updateNavigation();
        }

        function updateProgress() {
            const answered = Object.keys(answers).length;
            const total = currentQuiz.questions.length;
            const percentage = (answered / total) * 100;
            
            document.getElementById('progress-bar').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = `${answered}/${total} answered`;
        }

        function updateQuestionIndicators() {
            const indicators = document.querySelectorAll('#question-indicators button');
            indicators.forEach((indicator, index) => {
                if (answers.hasOwnProperty(index)) {
                    indicator.className = 'btn btn-success btn-sm';
                } else if (index === currentQuestion) {
                    indicator.className = 'btn btn-primary btn-sm';
                } else {
                    indicator.className = 'btn btn-outline-primary btn-sm';
                }
            });
        }

        function updateNavigation() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const submitBtn = document.getElementById('submit-btn');
            
            prevBtn.disabled = currentQuestion === 0;
            
            if (currentQuestion === currentQuiz.questions.length - 1) {
                nextBtn.classList.add('d-none');
                submitBtn.classList.remove('d-none');
            } else {
                nextBtn.classList.remove('d-none');
                submitBtn.classList.add('d-none');
            }
        }

        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentQuestion > 0) {
                loadQuestion(currentQuestion - 1);
            }
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            if (currentQuestion < currentQuiz.questions.length - 1) {
                loadQuestion(currentQuestion + 1);
            }
        });

        document.getElementById('submit-btn').addEventListener('click', submitQuiz);

        async function submitQuiz() {
            if (timer) {
                clearInterval(timer);
            }
            
            // Calculate time spent
            const timeSpent = Math.floor((Date.now() - startTime) / 1000);
            
            // Prepare answers array
            const answersArray = [];
            for (let i = 0; i < currentQuiz.questions.length; i++) {
                answersArray.push(answers[i] !== undefined ? answers[i] : -1);
            }
            
            try {
                const response = await fetch('/api/submit_quiz', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        quiz_id: currentQuiz.id,
                        answers: answersArray,
                        time_spent: timeSpent
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showResults(result);
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to submit quiz');
                }
            } catch (error) {
                alert('Error submitting quiz: ' + error.message);
            }
        }

        function showResults(result) {
            document.getElementById('quiz-interface').classList.add('d-none');
            document.getElementById('quiz-results').classList.remove('d-none');
            
            const score = result.score;
            document.getElementById('final-score').textContent = score + '%';
            
            // Set result styling based on score
            const scoreCircle = document.getElementById('score-circle');
            const resultTitle = document.getElementById('result-title');
            const resultMessage = document.getElementById('result-message');
            
            if (score >= 90) {
                scoreCircle.className = 'text-success mb-4';
                resultTitle.textContent = 'ðŸŽ‰ Outstanding!';
                resultMessage.textContent = `You scored ${result.correct_answers}/${result.total_questions} questions correctly. Excellent mastery of the subject!`;
            } else if (score >= 80) {
                scoreCircle.className = 'text-success mb-4';
                resultTitle.textContent = 'ðŸŒŸ Excellent Work!';
                resultMessage.textContent = `You got ${result.correct_answers}/${result.total_questions} questions right. Great understanding of the material!`;
            } else if (score >= 70) {
                scoreCircle.className = 'text-warning mb-4';
                resultTitle.textContent = 'ðŸ‘ Good Job!';
                resultMessage.textContent = `You answered ${result.correct_answers}/${result.total_questions} questions correctly. You're on the right track!`;
            } else if (score >= 60) {
                scoreCircle.className = 'text-warning mb-4';
                resultTitle.textContent = 'ðŸ“š Keep Learning!';
                resultMessage.textContent = `You got ${result.correct_answers}/${result.total_questions} questions right. Focus on the fundamentals and keep practicing.`;
            } else {
                scoreCircle.className = 'text-danger mb-4';
                resultTitle.textContent = 'ðŸ’ª Keep Trying!';
                resultMessage.textContent = `You answered ${result.correct_answers}/${result.total_questions} questions correctly. Don't give up - review the material and try again!`;
            }
            
            // Show feedback
            if (result.feedback) {
                document.getElementById('feedback-section').innerHTML = `
                    <i class="fas fa-robot me-2"></i><strong>AI Feedback:</strong><br>
                    ${result.feedback}
                `;
            }
        }

        function resetQuiz() {
            currentQuiz = null;
            currentQuestion = 0;
            answers = {};
            
            if (timer) {
                clearInterval(timer);
            }
            
            document.getElementById('quiz-results').classList.add('d-none');
            document.getElementById('quiz-interface').classList.add('d-none');
            document.getElementById('quiz-setup').classList.remove('d-none');
            
            // Reset form
            document.getElementById('quiz-form').reset();
            document.getElementById('quiz-form').classList.remove('was-validated');
            updateQuestionCount(5);
        }
    </script>
</body>
</html>